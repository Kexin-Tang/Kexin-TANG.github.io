<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Kexin">
    
    <title>
        
            Java 深入集合原理之ArrayList |
        
        Kexin Tang
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/cat.png">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"kexin-tang.github.io","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#ef476f","avatar":"/images/cat.png","favicon":"/images/cat.png","article_img_align":"center","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/sea.jpg","description":"<tag> Too many people, too little soul... </tag>"},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":false},"lazyload":{"enable":true},"version":"3.4.2"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div
        class="header-content">
        <div class="left">
            <a class="logo-title" href="/">
                Kexin Tang
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                                href="/">
                                HOME
                                    <!-- Home -->
                            </a>
                        </li>
                        
                        <li class="menu-item">
                            <a class=""
                                href="/archives">
                                ARCHIVE
                                    <!-- Archive -->
                            </a>
                        </li>
                        
                        <li class="menu-item">
                            <a class=""
                                href="/categories">
                                CATEGORY
                                    <!-- Category -->
                            </a>
                        </li>
                        
                        <li class="menu-item">
                            <a class=""
                                href="/tags">
                                TAG
                                    <!-- Tag -->
                            </a>
                        </li>
                        
                        <li class="menu-item">
                            <a class=""
                                href="/CV/CV.pdf">
                                CV
                                    <!-- CV -->
                            </a>
                        </li>
                        
                        <li class="menu-item">
                            <a class=""
                                href="/about">
                                ABOUT
                                    <!-- About -->
                            </a>
                        </li>
                        
                            
                                <li class="menu-item search search-popup-trigger">
                                    <i class="fas fa-search"></i>
                                </li>
                                
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                    
                        <div class="icon-item menu-bar">
                            <div class="menu-bar-middle"></div>
                        </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                        href="/">
                        HOME
                    </a>
                </li>
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                        href="/archives">
                        ARCHIVE
                    </a>
                </li>
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                        href="/categories">
                        CATEGORY
                    </a>
                </li>
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                        href="/tags">
                        TAG
                    </a>
                </li>
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                        href="/CV/CV.pdf">
                        CV
                    </a>
                </li>
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                        href="/about">
                        ABOUT
                    </a>
                </li>
                
        </ul>
    </div>

    <div class="window-mask"></div>

</header>
        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">
                Java 深入集合原理之ArrayList
            </span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/cat.png">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">
                            Kexin
                        </span>
                        <!-- 
                            <span class="author-label">Lv4</span>
                         -->
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2021-07-12 23:00:52
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Java/">Java</a>&nbsp;
                    </li>
                
                    <li>
                        &gt; <a href="/categories/Java/%E6%A6%82%E5%BF%B5/">概念</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E6%A6%82%E5%BF%B5/">概念</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Java/">Java</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>3.8k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>15 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
            

                    <div class="article-content markdown-body">
                        <h1 id="底层数据结构"><a href="#底层数据结构" class="headerlink" title="底层数据结构"></a>底层数据结构</h1><p>ArrayList底层是<strong>可变长的数组</strong>。</p>
<p>对于查询和更改，直接根据索引即可。</p>
<p>对于增加，需要先计算原数组长度，然后长度+1，new新的数组，将原数组内容拷贝，再在最末尾设置新元素；对于删除，需要计算原数组长度，然后-1，并且将删除位置之后的元素前移，然后new新数组，将内容拷贝。</p>
<p>由此看出，数组的特点就是：<strong>添加和删除效率低，查询效率高</strong>。</p>
<h1 id="ArrayList-继承关系"><a href="#ArrayList-继承关系" class="headerlink" title="ArrayList 继承关系"></a><em>ArrayList</em> 继承关系</h1><h2 id="Serializable-标记型接口"><a href="#Serializable-标记型接口" class="headerlink" title="Serializable 标记型接口"></a><em>Serializable</em> 标记型接口</h2><p>类的序列化由实现 <em>java.io.Serializable</em> 接口的类启用。</p>
<p>不实现此接口的类无法实现序列化/反序列化。</p>
<p>可序列化类的所有子类都可以序列化。</p>
<p>序列化接口没有方法或字段，只是标记状态而已。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Serializable接口源码</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RandomAccess-标记型接口"><a href="#RandomAccess-标记型接口" class="headerlink" title="RandomAccess 标记型接口"></a><em>RandomAccess</em> 标记型接口</h2><p>一个类实现 <em>RandomAccess</em> 接口来指示该类可以被随机访问，这样便于在应用于<strong>随机访问</strong>或<strong>顺序访问</strong>时获得高性能。</p>
<blockquote>
<p>使用<code>for(int i=0; i&lt;n; i++)</code>这种属于随机访问，因为实际上 <em>i</em> 可以取任意值，数组也不一定就按顺序被访问；使用增强for循环或者迭代器方式，就是顺序访问，因为要按顺序访问 <em>next</em>。</p>
</blockquote>
<h2 id="Cloneable-标记型接口"><a href="#Cloneable-标记型接口" class="headerlink" title="Cloneable 标记型接口"></a><em>Cloneable</em> 标记型接口</h2><p>一个类实现 <em>Cloneable</em> 接口来指示 <em>Object.clone()</em> 方法，该方法对于该类的实例进行字段的复制是合法的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Cloneable源码</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cloneable</span></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用克隆"><a href="#使用克隆" class="headerlink" title="使用克隆"></a>使用克隆</h3><ol>
<li>被克隆对象所在类必须实现 <em>Cloneable</em> 接口</li>
<li>在类内要重写 <em>clone</em> 方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    自定义Person类中重写clone()</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Person <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Person o = <span class="keyword">null</span>;</span><br><span class="line">            o = (Person) <span class="keyword">super</span>.clone();</span><br><span class="line">            <span class="keyword">return</span> o;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            <span class="comment">// this shouldn&#x27;t happen, since we are Cloneable</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>为什么调用<code>super.clone()</code>而不是new一个新的ArrayList? 因为此处的 <em>super</em> 指代的是 <em>Object</em>，而 <em>Object</em> 中的 <em>clone</em> 使用了基于C语言和操作系统内核的高效代码，效率比new更好。</p>
<blockquote>
<p>注意，使用 <em>clone</em> 返回的是 <em>Object</em> 类型，有必要的话需要强制类型转换。</p>
</blockquote>
<h3 id="浅拷贝"><a href="#浅拷贝" class="headerlink" title="浅拷贝"></a>浅拷贝</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    我们定义了一个Person类，其含有一个String属性，一个Integer属性和一个Skill属性</span></span><br><span class="line"><span class="comment">    该Skill属性是另一个用户自定义的类，含有一个String属性</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">    Skill s = <span class="keyword">new</span> Skill(<span class="string">&quot;动感光波&quot;</span>);</span><br><span class="line">    Person p1 = <span class="keyword">new</span> Person(<span class="string">&quot;咸蛋超人&quot;</span>, <span class="number">18</span>, s);</span><br><span class="line">    Person p2 = p1.clone();     <span class="comment">// clone是浅拷贝方法</span></span><br><span class="line"></span><br><span class="line">    System.out.println(p1==p2);</span><br><span class="line"></span><br><span class="line">    System.out.println(p1); </span><br><span class="line">    System.out.println(p2); </span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;========&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    p1.setName(<span class="string">&quot;开心超人&quot;</span>)</span><br><span class="line">    p1.setAge(<span class="number">30</span>);</span><br><span class="line">    p1.setSkill(<span class="string">&quot;biu~biu~biu~&quot;</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(p1); </span><br><span class="line">    System.out.println(p2); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">false</span><br><span class="line">&#123;name&#x3D;&quot;咸蛋超人&quot;,age&#x3D;18,skill&#x3D;&quot;动感光波&quot;&#125;</span><br><span class="line">&#123;name&#x3D;&quot;咸蛋超人&quot;,age&#x3D;18,skill&#x3D;&quot;动感光波&quot;&#125;</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#123;name&#x3D;&quot;开心超人&quot;,age&#x3D;30,skill&#x3D;&quot;biu~biu~biu~&quot;&#125;</span><br><span class="line">&#123;name&#x3D;&quot;咸蛋超人&quot;,age&#x3D;18,skill&#x3D;&quot;biu~biu~biu~&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>浅拷贝就像上面代码所示：<strong>基本数据类型可以实现“独立更改，互不影响”，但是引用类型会“牵一发而动全身”</strong>。</p>
<p><a href="https://sm.ms/image/ENeyPSjivWkzoBg" target="_blank"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2021/07/13/ENeyPSjivWkzoBg.png"
                      
                ></a></p>
<h3 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h3><p>为了实现深拷贝，我们需要修改多个地方。</p>
<p>首先是 <em>Skill</em> 类中同样需要实现 <em>Cloneable</em> 接口并重写 <em>clone</em> 方法，返回 <code>super.clone()</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Skill</span> <span class="keyword">implements</span> <span class="title">Cloneable</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Skill <span class="title">clone</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Skill) <span class="keyword">super</span>.clone();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其次是 <em>Person</em> 类中的 <em>clone</em> 函数不能是简单的直接使用 <em>Object.clone</em>，而需要重新设置引用对象的指向。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Cloneable</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">clone</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Person p = (Person) <span class="keyword">super</span>.clone();  <span class="comment">// 将内容拷贝，包括了引用内容，但主要目的是复制基本类型内容</span></span><br><span class="line">        Skill s = <span class="keyword">this</span>.skill.clone();   <span class="comment">// 将Skill内容拷贝到一个新的内存区域，这样以后修改引用内容时，两个内存区域就隔离了</span></span><br><span class="line">        p.setSkill(s);  <span class="comment">// 将本对象的引用类型内容指向新建的区域</span></span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://sm.ms/image/8qjm7cTkWH2uobg" target="_blank"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://i.loli.net/2021/07/14/8qjm7cTkWH2uobg.png"
                      
                ></a></p>
<hr>
<h1 id="ArrayList-源码分析"><a href="#ArrayList-源码分析" class="headerlink" title="ArrayList 源码分析"></a><em>ArrayList</em> 源码分析</h1><h2 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h2><h3 id="空参构造"><a href="#空参构造" class="headerlink" title="空参构造"></a>空参构造</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// 长度为0的空数组</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Object类型的数组，ArrayList真正存储内容的数组</span></span><br><span class="line">    <span class="keyword">transient</span> Object[] elementData;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 空参构造</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由此可见，整个过程就是把空内容赋值给底层存储元素的elementData数组。</p>
<p><strong>注意</strong>：<em>elementData.length</em> 代表了数组的实际容量，而 <em>size</em> 代表的是数组中非null元素的个数，因此，**<code>size&lt;=elementData.length</code>**。由于 <em>elementData</em> 会保存一些未被初始化或赋值的 null 元素，而这些元素在序列化等操作时可以省去，因此我们使用 transient 关键字，只需要将非null的元素进行序列化、持久化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;Integer&gt; a = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">a.add(<span class="number">10</span>);</span><br><span class="line">a.add(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    [10, 10, null, null, null]</span></span><br><span class="line"><span class="comment">    &lt;-size-&gt;</span></span><br><span class="line"><span class="comment">    &lt;-  elementData.length  -&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    a           -&gt; [10, 10]</span></span><br><span class="line"><span class="comment">    elementData -&gt; [10, 10, null, null, null]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="指定数组长度的构造"><a href="#指定数组长度的构造" class="headerlink" title="指定数组长度的构造"></a>指定数组长度的构造</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Illegal Capacity: &quot;</span>+ initialCapacity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="指定集合的构造"><a href="#指定集合的构造" class="headerlink" title="指定集合的构造"></a>指定集合的构造</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">        Object[] a = c.toArray();   <span class="comment">// a存储c的内容</span></span><br><span class="line">        <span class="keyword">if</span> ((size = a.length) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c.getClass() == ArrayList.class) &#123;</span><br><span class="line">                elementData = a;    <span class="comment">// 如果c就是ArrayList，那么直接让底层数组指向a</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果c不是ArrayList，那么先把内容复制，并保存为Object类型</span></span><br><span class="line">                elementData = Arrays.copyOf(a, size, Object[].class);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// replace with empty array.</span></span><br><span class="line">            elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加方法"><a href="#添加方法" class="headerlink" title="添加方法"></a>添加方法</h2><h3 id="public-boolean-add-E-e"><a href="#public-boolean-add-E-e" class="headerlink" title="public boolean add(E e)"></a><em>public boolean add(E e)</em></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">        modCount++;                 <span class="comment">// 操作次数++</span></span><br><span class="line">        add(e, elementData, size);  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(E e, Object[] elementData, <span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s == elementData.length)    <span class="comment">// 如果已经把容量塞满，则需要扩容</span></span><br><span class="line">            elementData = grow();</span><br><span class="line">        elementData[s] = e;             <span class="comment">// 设置指定位置的元素</span></span><br><span class="line">        size = s + <span class="number">1</span>;                   <span class="comment">// 元素个数++</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object[] grow() &#123;</span><br><span class="line">        <span class="keyword">return</span> grow(size + <span class="number">1</span>);          <span class="comment">// 扩容</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扩容的实际操作：新建一个更长的数组，并把原来的内容复制进去</span></span><br><span class="line">    <span class="keyword">private</span> Object[] grow(<span class="keyword">int</span> minCapacity) &#123;</span><br><span class="line">        <span class="keyword">return</span> elementData = Arrays.copyOf(elementData,</span><br><span class="line">                                           newCapacity(minCapacity));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">newCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// overflow-conscious code</span></span><br><span class="line">        <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">        <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>); <span class="comment">// 设想扩容1.5倍</span></span><br><span class="line">        <span class="keyword">if</span> (newCapacity - minCapacity &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA)</span><br><span class="line">                <span class="keyword">return</span> Math.max(DEFAULT_CAPACITY, minCapacity);</span><br><span class="line">            <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">            <span class="keyword">return</span> minCapacity;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (newCapacity - MAX_ARRAY_SIZE &lt;= <span class="number">0</span>)</span><br><span class="line">            ? newCapacity</span><br><span class="line">            : hugeCapacity(minCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="public-boolean-add-int-index-E-e"><a href="#public-boolean-add-int-index-E-e" class="headerlink" title="public boolean add(int index, E e)"></a><em>public boolean add(int index, E e)</em></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">        rangeCheckForAdd(index);    <span class="comment">// 检查传入的索引是否越界</span></span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> s;</span><br><span class="line">        Object[] elementData;</span><br><span class="line">        <span class="comment">// 如果当前的列表长度 == 列表容量，即已经填满了，需要扩容</span></span><br><span class="line">        <span class="keyword">if</span> ((s = size) == (elementData = <span class="keyword">this</span>.elementData).length)</span><br><span class="line">            elementData = grow();</span><br><span class="line">        <span class="comment">// 将elementData中index起始的内容向后移动一格至index+1起始</span></span><br><span class="line">        System.arraycopy(elementData, index,</span><br><span class="line">                         elementData, index + <span class="number">1</span>,</span><br><span class="line">                         s - index);</span><br><span class="line">        <span class="comment">// 将空余的index位置赋予元素</span></span><br><span class="line">        elementData[index] = element;   </span><br><span class="line">        size = s + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="public-boolean-addAll-Collection-lt-extends-E-gt-c"><a href="#public-boolean-addAll-Collection-lt-extends-E-gt-c" class="headerlink" title="public boolean addAll(Collection&lt;? extends E&gt; c)"></a><em>public boolean addAll(Collection&lt;? extends E&gt; c)</em></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">        Object[] a = c.toArray();</span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="keyword">int</span> numNew = a.length;</span><br><span class="line">        <span class="keyword">if</span> (numNew == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        Object[] elementData;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> s;</span><br><span class="line">        <span class="comment">// 如果 新加入数组长度&gt;容量-已有数组长度，则扩容</span></span><br><span class="line">        <span class="keyword">if</span> (numNew &gt; (elementData = <span class="keyword">this</span>.elementData).length - (s = size))</span><br><span class="line">            elementData = grow(s + numNew);</span><br><span class="line">        <span class="comment">// 将元素进行拷贝</span></span><br><span class="line">        System.arraycopy(a, <span class="number">0</span>, elementData, s, numNew);</span><br><span class="line">        size = s + numNew;  <span class="comment">// 元素个数++</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="public-boolean-addAll-int-index-Collection-lt-extends-E-gt-c"><a href="#public-boolean-addAll-int-index-Collection-lt-extends-E-gt-c" class="headerlink" title="public boolean addAll(int index, Collection&lt;? extends E&gt; c)"></a><em>public boolean addAll(int index, Collection&lt;? extends E&gt; c)</em></h3><p>与之前的分析类似，不再赘述。</p>
<hr>
<h2 id="设置方法"><a href="#设置方法" class="headerlink" title="设置方法"></a>设置方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">        Objects.checkIndex(index, size);    <span class="comment">// 检查下标合法性</span></span><br><span class="line">        E oldValue = elementData(index);    <span class="comment">// 保存旧值</span></span><br><span class="line">        elementData[index] = element;       <span class="comment">// 设置新值</span></span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="获取方法"><a href="#获取方法" class="headerlink" title="获取方法"></a>获取方法</h2><p>与上面设置方法类似，只不过免去了“设置新值”的步骤。</p>
<hr>
<h2 id="删除方法"><a href="#删除方法" class="headerlink" title="删除方法"></a>删除方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        Objects.checkIndex(index, size);    <span class="comment">// 检查索引的有效性</span></span><br><span class="line">        <span class="keyword">final</span> Object[] es = elementData;    <span class="comment">// 将所有元素保存到局部变量</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> E oldValue = (E) es[index];  <span class="comment">// 获取要删除的值</span></span><br><span class="line">        fastRemove(es, index);  <span class="comment">// 删除</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fastRemove</span><span class="params">(Object[] es, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        modCount++;         <span class="comment">// 注意，此时删除会使 操作次数++</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newSize;</span><br><span class="line">        <span class="keyword">if</span> ((newSize = size - <span class="number">1</span>) &gt; i)</span><br><span class="line">            System.arraycopy(es, i + <span class="number">1</span>, es, i, newSize - i);</span><br><span class="line">        es[size = newSize] = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString"></a><em>toString</em></h2><p>调用的是父类 <em>AbstractCollection</em> 中的 <em>toString</em> 方法，内部就是使用了 <em>StringBuilder</em>，不再赘述。</p>
<hr>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Itr();   <span class="comment">// 获取迭代器对象</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部类，定义了迭代器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Itr</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> cursor;       <span class="comment">// 下一个返回元素的下标</span></span><br><span class="line">        <span class="keyword">int</span> lastRet = -<span class="number">1</span>; <span class="comment">// 上一个返回元素的下标，最初始为-1</span></span><br><span class="line">        <span class="keyword">int</span> expectedModCount = modCount;    <span class="comment">// 将数组实际操作次数赋给预期操作次数</span></span><br><span class="line"></span><br><span class="line">        Itr() &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是否有还有其他元素</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> cursor != size;  <span class="comment">// 如果下标还没遍历到末尾，则代表还有其他元素</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> E <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            checkForComodification();   <span class="comment">// 检测并发修改异常</span></span><br><span class="line">            <span class="keyword">int</span> i = cursor;</span><br><span class="line">            <span class="comment">// 判断当前下标是否越界</span></span><br><span class="line">            <span class="keyword">if</span> (i &gt;= size)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">            Object[] elementData = ArrayList.<span class="keyword">this</span>.elementData;</span><br><span class="line">            <span class="keyword">if</span> (i &gt;= elementData.length)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">            <span class="comment">// 如果下标一切正常，则指向下一个下标</span></span><br><span class="line">            cursor = i + <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 指向上一个元素的光标lastRet指向当前位置，并将内容返回</span></span><br><span class="line">            <span class="keyword">return</span> (E) elementData[lastRet = i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 校验并发修改异常，如果预期修改次数 != 实际修改次数，则抛出异常</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkForComodification</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="并发修改异常"><a href="#并发修改异常" class="headerlink" title="并发修改异常"></a>并发修改异常</h3><p>并发修改异常：预期修改次数为n，实际修改次数为m，如果<code>m!=n</code>，就相当于读取的数据和写入的数据不一致，就会引发修改异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;c&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Iterator&lt;String&gt; it = list.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(it.hasNext())&#123;</span><br><span class="line">        String s = it.next();</span><br><span class="line">        <span class="keyword">if</span> (s.equals(<span class="string">&quot;c&quot;</span>))&#123;</span><br><span class="line">            list.remove(<span class="string">&quot;c&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中，预期修改次数为3，因为在获取迭代器之前进行了3次写入。但是在while中，出现了删除语句，使得实际修改次数为4，即3次写入+1次擦除。同时，当我们删除最后一个元素时，由于在<code>it.hasNext()</code>中，此时的cursor为3，但是数组的size为2，因此还是会进入while循环，然后引发<code>it.next()</code>中的异常。</p>
<blockquote>
<p><strong>坑</strong>：<u>当我们删除的元素是倒数第二个时，不会引发任何错误</u>。因为当我们遍历到倒数第二个元素时，此时执行删除，<code>expectedModCount != modCount</code>，但是抛出异常的内容在<code>it.next()</code>中，需要等待下一次进入while。而此时删除一个元素后，<code>cursor == size</code>，意味着下一次while不会进入了，因此直接跳出循环，不会抛出异常。</p>
</blockquote>
<h3 id="迭代器-remove"><a href="#迭代器-remove" class="headerlink" title="迭代器.remove()"></a>迭代器.remove()</h3><p>之前会引发并发修改错误的代码中使用的是ArrayList中的<code>remove</code>方法。如果想在使用迭代器时实现安全的删除，可以使用迭代器自带的<code>remove()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Itr</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (lastRet &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">            checkForComodification();   <span class="comment">// 在删除前查看是否会并发修改异常</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ArrayList.<span class="keyword">this</span>.remove(lastRet); <span class="comment">// 实际上还是调用ArrayList的删除</span></span><br><span class="line">                <span class="comment">// 删除后设置混乱的cursor、预期修改次数等</span></span><br><span class="line">                <span class="comment">// 免去了下次调用时出现并发修改异常</span></span><br><span class="line">                cursor = lastRet; </span><br><span class="line">                lastRet = -<span class="number">1</span>;</span><br><span class="line">                expectedModCount = modCount;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="常见面试题"><a href="#常见面试题" class="headerlink" title="常见面试题"></a>常见面试题</h1><h2 id="1-ArrayList-如何扩容？"><a href="#1-ArrayList-如何扩容？" class="headerlink" title="1. ArrayList 如何扩容？"></a>1. <em>ArrayList</em> 如何扩容？</h2><p>第一次扩容量为10，之后每一次都是1.5倍。</p>
<blockquote>
<p>在分析 <em>add</em> 方法时，分析过其 <em>grow</em> 和 <em>newCapacity</em> 源码。</p>
</blockquote>
<h2 id="2-ArrayList-频繁扩容导致性能下降，如何优化？"><a href="#2-ArrayList-频繁扩容导致性能下降，如何优化？" class="headerlink" title="2. ArrayList 频繁扩容导致性能下降，如何优化？"></a>2. <em>ArrayList</em> 频繁扩容导致性能下降，如何优化？</h2><p>可以根据业务需求，使用带 <em>capacity</em> 的构造方法，一次性开辟相应数量级的空间。</p>
<h2 id="3-ArrayList-插入和删除一定比-LinkedList-慢吗？"><a href="#3-ArrayList-插入和删除一定比-LinkedList-慢吗？" class="headerlink" title="3. ArrayList 插入和删除一定比 LinkedList 慢吗？"></a>3. <em>ArrayList</em> 插入和删除一定比 <em>LinkedList</em> 慢吗？</h2><p>不一定。</p>
<p>插入和删除有两步：（1）找到对应位置；（2）插入/删除。对于 <em>ArrayList</em> 而言，其（1）速度快，因为是随机访问，但是（2）速度慢；对于 <em>LinkedList</em> 而言，其（1）速度慢，因为是顺序访问，但是（2）速度快。因此，这两者都是一快一慢的结合，最终的用时就不一定谁快谁慢。</p>
<blockquote>
<p>比如说有 100w 条数据，要删除第 999999 条数据（倒数第二条），那么 <em>ArrayList</em> 可以很短时间找到，同时只需要移动一个数据（倒数第一个数据前移），用时也非常短。但是 <em>LinkedList</em> 需要顺序查找 999999 次，再通过改变指向完成删除。</p>
</blockquote>
<p>除此之外，还有一个原因：<em>LinkedList</em> 是通过维护一个 <em>Node</em> 结构实现，每次删除和插入都需要重新维护该结构；而 <em>ArrayList</em> 每次都会预先分配一块区域，只有容量不足才会扩容，即并不是每次插入和删除都需要维护底层结构。</p>
<h2 id="4-ArrayList-是线程安全的吗？"><a href="#4-ArrayList-是线程安全的吗？" class="headerlink" title="4. ArrayList 是线程安全的吗？"></a>4. <em>ArrayList</em> 是线程安全的吗？</h2><p>不是线程安全的。</p>
<p>线程安全就是多线程访问时，采用了加锁机制，当一个线程访问该类的某个数据时，进行保护，其他线程不能进行访问直到该线程读取完，其他线程才可使用。不会出现数据不一致或者数据污染。线程不安全就是不提供数据访问保护，有可能出现多个线程先后更改数据造成所得到的数据是脏数据。 </p>
<p>比如说有A，B两个线程，都准备向 <em>arr</em> 中添加一个元素。在 <em>ArrayList</em> 中加入一个元素有两步——（1）放入元素；（2）更改数组长度。我们假设发生如下的过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    A           B</span><br><span class="line">-----------------------------------------------</span><br><span class="line">放入元素a                   arr &#x3D; [a],  size &#x3D; 0</span><br><span class="line">            放入元素b       arr &#x3D; [b],  size &#x3D; 0</span><br><span class="line">            数组长度变化     arr &#x3D; [b],  size &#x3D; 1</span><br><span class="line">数组长度变化                 arr &#x3D; [b],  size &#x3D; 2</span><br></pre></td></tr></table></figure>

<p>想要解决线程安全的问题，有多种方法：</p>
<ol>
<li>使用低效率但线程安全的 <em>Vector</em></li>
<li>使用Java中同步加锁的各种机制，比如使用synchronized关键字</li>
<li>使用Collections.synchronizedList(new ArrayList&lt;&gt;())，把线程不安全集合变为线程安全集合</li>
</ol>
<p>什么时候要考虑线程安全呢？假设一个 <em>ArrayList</em> 是局部变量，不是全局变量，那么可以考虑不用加线程安全，因为局部变量不是共享的资源，每个线程独占，就不用考虑多线程。</p>
<h2 id="5-如何复制-ArrayList"><a href="#5-如何复制-ArrayList" class="headerlink" title="5. 如何复制 ArrayList"></a>5. 如何复制 <em>ArrayList</em></h2><ul>
<li>clone()</li>
<li>new ArrayList(arraylist)</li>
<li>addAll(arraylist)</li>
<li>循环add</li>
<li>Arrays工具类中的copyOf()</li>
</ul>
<h2 id="6-在多线程时，使用迭代器读取-ArrayList-数据，如何保证可以正常写入数据到集合？"><a href="#6-在多线程时，使用迭代器读取-ArrayList-数据，如何保证可以正常写入数据到集合？" class="headerlink" title="6. 在多线程时，使用迭代器读取 ArrayList 数据，如何保证可以正常写入数据到集合？"></a>6. 在多线程时，使用迭代器读取 <em>ArrayList</em> 数据，如何保证可以正常写入数据到集合？</h2><p>使用 <em>CopyOnWriteArrayList</em> 类代替 <em>ArrayList</em>。</p>
<p>该类会创建一个 原<em>ArrayList</em> 的副本，保证该副本在读的时候不被更改，而迭代器生命周期内迭代的就是这个副本。至于其他的更改，会在真正的原数据上进行，但是由于副本已经被创建，所以不会影响迭代器。</p>

                    </div>

                    

                            
                                <div class="article-nav">
                                    
                                            
                                                <div class="article-next">
                                                    <a class="next" rel="next" href="/2021/07/12/Java-%E5%8F%8D%E5%B0%84/">
                                                        <span class="title flex-center">
                                                            <span class="post-nav-title-item">
                                                                Java 反射
                                                            </span>
                                                            <span class="post-nav-item">
                                                                Next posts
                                                            </span>
                                                        </span>
                                                        <span class="right arrow-icon flex-center">
                                                            <i class="fas fa-chevron-right"></i>
                                                        </span>
                                                    </a>
                                                </div>
                                                
                                </div>
                                

                                    
    </div>
</div>

                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>&nbsp;-&nbsp;
            
            2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Kexin</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.2</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text">底层数据结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ArrayList-%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB"><span class="nav-text">ArrayList 继承关系</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Serializable-%E6%A0%87%E8%AE%B0%E5%9E%8B%E6%8E%A5%E5%8F%A3"><span class="nav-text">Serializable 标记型接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RandomAccess-%E6%A0%87%E8%AE%B0%E5%9E%8B%E6%8E%A5%E5%8F%A3"><span class="nav-text">RandomAccess 标记型接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cloneable-%E6%A0%87%E8%AE%B0%E5%9E%8B%E6%8E%A5%E5%8F%A3"><span class="nav-text">Cloneable 标记型接口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%85%8B%E9%9A%86"><span class="nav-text">使用克隆</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%85%E6%8B%B7%E8%B4%9D"><span class="nav-text">浅拷贝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B1%E6%8B%B7%E8%B4%9D"><span class="nav-text">深拷贝</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ArrayList-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">ArrayList 源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="nav-text">构造方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%BA%E5%8F%82%E6%9E%84%E9%80%A0"><span class="nav-text">空参构造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E6%95%B0%E7%BB%84%E9%95%BF%E5%BA%A6%E7%9A%84%E6%9E%84%E9%80%A0"><span class="nav-text">指定数组长度的构造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E9%9B%86%E5%90%88%E7%9A%84%E6%9E%84%E9%80%A0"><span class="nav-text">指定集合的构造</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95"><span class="nav-text">添加方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#public-boolean-add-E-e"><span class="nav-text">public boolean add(E e)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#public-boolean-add-int-index-E-e"><span class="nav-text">public boolean add(int index, E e)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#public-boolean-addAll-Collection-lt-extends-E-gt-c"><span class="nav-text">public boolean addAll(Collection&lt;? extends E&gt; c)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#public-boolean-addAll-int-index-Collection-lt-extends-E-gt-c"><span class="nav-text">public boolean addAll(int index, Collection&lt;? extends E&gt; c)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E6%96%B9%E6%B3%95"><span class="nav-text">设置方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95"><span class="nav-text">获取方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%96%B9%E6%B3%95"><span class="nav-text">删除方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#toString-NaN"><span class="nav-text">toString</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="nav-text">迭代器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E4%BF%AE%E6%94%B9%E5%BC%82%E5%B8%B8"><span class="nav-text">并发修改异常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%AD%E4%BB%A3%E5%99%A8-remove"><span class="nav-text">迭代器.remove()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="nav-text">常见面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-ArrayList-%E5%A6%82%E4%BD%95%E6%89%A9%E5%AE%B9%EF%BC%9F"><span class="nav-text">1. ArrayList 如何扩容？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-ArrayList-%E9%A2%91%E7%B9%81%E6%89%A9%E5%AE%B9%E5%AF%BC%E8%87%B4%E6%80%A7%E8%83%BD%E4%B8%8B%E9%99%8D%EF%BC%8C%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96%EF%BC%9F"><span class="nav-text">2. ArrayList 频繁扩容导致性能下降，如何优化？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-ArrayList-%E6%8F%92%E5%85%A5%E5%92%8C%E5%88%A0%E9%99%A4%E4%B8%80%E5%AE%9A%E6%AF%94-LinkedList-%E6%85%A2%E5%90%97%EF%BC%9F"><span class="nav-text">3. ArrayList 插入和删除一定比 LinkedList 慢吗？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-ArrayList-%E6%98%AF%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84%E5%90%97%EF%BC%9F"><span class="nav-text">4. ArrayList 是线程安全的吗？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%A6%82%E4%BD%95%E5%A4%8D%E5%88%B6-ArrayList"><span class="nav-text">5. 如何复制 ArrayList</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%9C%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%97%B6%EF%BC%8C%E4%BD%BF%E7%94%A8%E8%BF%AD%E4%BB%A3%E5%99%A8%E8%AF%BB%E5%8F%96-ArrayList-%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%8F%AF%E4%BB%A5%E6%AD%A3%E5%B8%B8%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%88%B0%E9%9B%86%E5%90%88%EF%BC%9F"><span class="nav-text">6. 在多线程时，使用迭代器读取 ArrayList 数据，如何保证可以正常写入数据到集合？</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
